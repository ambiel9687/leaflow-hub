<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leaflow Auto Check-in Control Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸƒ</text></svg>">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* é˜²æ­¢é¡µé¢é—ªçƒï¼šåˆå§‹éšè—æ‰€æœ‰å®¹å™¨ */
        .login-container, .dashboard { visibility: hidden; }
    </style>
    <script>
        // ç«‹å³æ ¹æ® token é¢„è®¾å®¹å™¨å¯è§æ€§ï¼Œé˜²æ­¢é—ªçƒ
        (function() {
            var hasToken = !!localStorage.getItem('authToken');
            var style = document.createElement('style');
            style.id = 'anti-flicker-style';
            style.textContent = hasToken
                ? '.login-container{display:none!important}.dashboard{display:block!important;visibility:visible!important}'
                : '.login-container{display:flex!important;visibility:visible!important}.dashboard{display:none!important}';
            document.head.appendChild(style);
        })();
    </script>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="button" class="btn btn-full" id="loginBtn" onclick="handleLogin()">ç™»å½•</button>
                <div class="error-message" id="loginError"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>ğŸƒ Leaflow è‡ªåŠ¨ç­¾åˆ°æ§åˆ¶é¢æ¿</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-sm" onclick="showCheckinSettingsModal()" title="ç­¾åˆ°è®¾ç½®">
                            <span>â°</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showNotificationModal()" title="é€šçŸ¥è®¾ç½®">
                            <span>ğŸ””</span>
                        </button>
                        <button class="btn btn-secondary btn-sm theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                            <span class="theme-icon">ğŸŒ™</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="logout()">é€€å‡º</button>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸€æ’ï¼šè´¦å·ä¸ç­¾åˆ°ç»Ÿè®¡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>è´¦å·æ€»æ•°</h3>
                    <div class="value value-default" id="totalAccounts">0</div>
                </div>
                <div class="stat-card">
                    <h3>æ´»è·ƒè´¦å·</h3>
                    <div class="value value-info" id="activeAccounts">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç­¾åˆ°æ€»æ•°</h3>
                    <div class="value value-default" id="totalCheckins">0</div>
                </div>
                <div class="stat-card">
                    <h3>æˆåŠŸç‡</h3>
                    <div class="value value-success" id="successRate">0%</div>
                </div>
            </div>

            <!-- ç¬¬äºŒæ’ï¼šä½™é¢ä¸æ¶ˆè´¹ç»Ÿè®¡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ€»ä½™é¢</h3>
                    <div class="value value-success" id="totalBalance">Â¥0.00</div>
                </div>
                <div class="stat-card">
                    <h3>æ€»æ¶ˆè´¹</h3>
                    <div class="value value-warning" id="totalConsumed">Â¥0.00</div>
                </div>
                <div class="stat-card">
                    <h3>ä½¿ç”¨ç‡</h3>
                    <div class="value value-info" id="usageRate">0%</div>
                </div>
                <div class="stat-card">
                    <h3>ä»Šæ—¥ç­¾åˆ°</h3>
                    <div class="value value-success" id="todayCheckinAmount">Â¥0.00</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>ğŸ‘¥ è´¦å·ç®¡ç†</h2>
                    <div class="button-group">
                        <button class="btn btn-success btn-sm" onclick="showAddAccountModal()">+ æ·»åŠ è´¦å·</button>
                        <button class="btn btn-info btn-sm" onclick="refreshAllBalances()">åˆ·æ–°å…¨éƒ¨ä½™é¢</button>
                        <button class="btn btn-warning btn-sm" onclick="clearCheckinHistory('today')">æ¸…ç©ºä»Šæ—¥è®°å½•</button>
                        <button class="btn btn-danger btn-sm" onclick="clearCheckinHistory('all')">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>åŸºç¡€ä¿¡æ¯</th>
                                <th>ä½™é¢ä¿¡æ¯</th>
                                <th>çŠ¶æ€</th>
                                <th>ä»Šæ—¥ç­¾åˆ°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="accountsList">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #a0aec0;">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°è´¦å·</h3>
                <button class="close" onclick="closeModal('addAccountModal')">&times;</button>
            </div>
            <div id="addAccountForm">
                <div class="form-group">
                    <label>è´¦å·åç§°</label>
                    <input type="text" id="accountName" required>
                </div>
                <div class="form-group">
                    <label>Cookie æ•°æ®</label>
                    <textarea id="tokenData" rows="6" placeholder='æ”¯æŒæ ¼å¼ï¼š
1. JSONæ ¼å¼: {"cookies": {"key": "value"}}
2. åˆ†å·åˆ†éš”: key1=value1; key2=value2
3. å®Œæ•´cookie: leaflow_session=xxx; remember_xxx=xxx; XSRF-TOKEN=xxx' required></textarea>
                    <div class="format-hint">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·(F12) â†’ Network â†’ è¯·æ±‚å¤´ â†’ Cookie å¤åˆ¶</div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-full" onclick="addAccount()">æ·»åŠ è´¦å·</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addAccountModal')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Account Modal -->
    <div class="modal" id="editAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editAccountTitle">ä¿®æ”¹è´¦å·</h3>
                <button class="close" onclick="closeModal('editAccountModal')">&times;</button>
            </div>
            <div id="editAccountForm">
                <input type="hidden" id="editAccountId">
                <div class="form-group">
                    <label>Cookie æ•°æ®ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                    <textarea id="editTokenData" rows="4" placeholder='æ”¯æŒæ ¼å¼ï¼š
1. JSONæ ¼å¼: {"cookies": {"key": "value"}}
2. åˆ†å·åˆ†éš”: key1=value1; key2=value2
3. å®Œæ•´cookie: leaflow_session=xxx; remember_xxx=xxx; XSRF-TOKEN=xxx'></textarea>
                    <div class="format-hint">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·(F12) â†’ Network â†’ è¯·æ±‚å¤´ â†’ Cookie å¤åˆ¶</div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-full" onclick="updateAccount()">ä¿å­˜ä¿®æ”¹</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editAccountModal')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkin History Modal -->
    <div class="modal" id="checkinHistoryModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="historyModalTitle">ç­¾åˆ°å†å²</h3>
                <button class="close" onclick="closeModal('checkinHistoryModal')">&times;</button>
            </div>
            <input type="hidden" id="historyAccountId">
            <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllHistory" onchange="toggleSelectAllHistory()"></th>
                            <th>çŠ¶æ€</th>
                            <th>æ¶ˆæ¯</th>
                            <th>é‡è¯•æ¬¡æ•°</th>
                            <th>æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="historyList">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #a0aec0;">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-danger" onclick="deleteSelectedHistory()">åˆ é™¤é€‰ä¸­</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('checkinHistoryModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal" id="notificationModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ğŸ”” é€šçŸ¥è®¾ç½®</h3>
                <button class="close" onclick="closeModal('notificationModal')">&times;</button>
            </div>
            <div class="modal-body-scroll">
                <div class="form-group">
                    <div class="form-group-inline">
                        <input type="checkbox" id="notifyEnabled">
                        <label for="notifyEnabled" style="margin-bottom: 0;">å¯ç”¨é€šçŸ¥åŠŸèƒ½</label>
                    </div>
                </div>

                <!-- Telegramé€šçŸ¥è®¾ç½® -->
                <div class="notification-channel">
                    <h4>ğŸ“± Telegram é€šçŸ¥è®¾ç½®</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="telegramEnabled">
                        <label for="telegramEnabled">å¯ç”¨ Telegram é€šçŸ¥</label>
                    </div>
                    <div class="form-group">
                        <label>Bot Token</label>
                        <input type="text" id="tgBotToken" placeholder="ä» @BotFather è·å–çš„ Bot Token">
                    </div>
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="tgUserId" placeholder="æ¥æ”¶é€šçŸ¥çš„ç”¨æˆ·ID">
                    </div>
                    <div class="form-group">
                        <label>APIåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="telegramHost" placeholder="https://api.telegram.org">
                        <div class="format-hint">ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€</div>
                    </div>
                </div>

                <!-- ä¼ä¸šå¾®ä¿¡é€šçŸ¥è®¾ç½® -->
                <div class="notification-channel">
                    <h4>ğŸ’¼ ä¼ä¸šå¾®ä¿¡é€šçŸ¥è®¾ç½®</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="wechatEnabled">
                        <label for="wechatEnabled">å¯ç”¨ä¼ä¸šå¾®ä¿¡é€šçŸ¥</label>
                    </div>
                    <div class="form-group">
                        <label>Webhook Key</label>
                        <input type="text" id="wechatKey" placeholder="ä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„ Webhook Key">
                    </div>
                    <div class="form-group">
                        <label>APIåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="wechatHost" placeholder="https://qyapi.weixin.qq.com">
                        <div class="format-hint">ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€</div>
                    </div>
                </div>

                <!-- WxPusheré€šçŸ¥è®¾ç½® -->
                <div class="notification-channel">
                    <h4>ğŸ“¨ WxPusher æ¶ˆæ¯é€šçŸ¥è®¾ç½®</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="wxpusherEnabled">
                        <label for="wxpusherEnabled">å¯ç”¨ WxPusher é€šçŸ¥</label>
                    </div>
                    <div class="form-group">
                        <label>APP Token</label>
                        <input type="text" id="wxpusherAppToken" placeholder="AT_xxx">
                        <div class="format-hint">
                            <a href="https://wxpusher.zjiecode.com/docs/#/" target="_blank" class="help-link">
                                è®¿é—® WxPusher æ–‡æ¡£è·å– Token å’Œ UID
                            </a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>UID</label>
                        <input type="text" id="wxpusherUid" placeholder="UID_xxx">
                    </div>
                    <div class="form-group">
                        <label>APIåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="wxpusherHost" placeholder="https://wxpusher.zjiecode.com">
                        <div class="format-hint">ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€</div>
                    </div>
                </div>

                <!-- é’‰é’‰æœºå™¨äººé€šçŸ¥è®¾ç½® -->
                <div class="notification-channel">
                    <h4>ğŸ¤– é’‰é’‰æœºå™¨äººé€šçŸ¥è®¾ç½®</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="dingtalkEnabled">
                        <label for="dingtalkEnabled">å¯ç”¨é’‰é’‰æœºå™¨äººé€šçŸ¥</label>
                    </div>
                    <div class="form-group">
                        <label>Access Token</label>
                        <input type="text" id="dingtalkAccessToken" placeholder="æœºå™¨äººçš„ Access Token">
                        <div class="format-hint">
                            <a href="https://open.dingtalk.com/document/orgapp/obtain-the-webhook-address-of-a-custom-robot" target="_blank" class="help-link">
                                è·å–é’‰é’‰æœºå™¨äººé…ç½®
                            </a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åŠ ç­¾å¯†é’¥</label>
                        <input type="text" id="dingtalkSecret" placeholder="å®‰å…¨è®¾ç½®ä¸­çš„åŠ ç­¾å¯†é’¥">
                    </div>
                    <div class="form-group">
                        <label>APIåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="dingtalkHost" placeholder="https://oapi.dingtalk.com">
                        <div class="format-hint">ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-full" onclick="saveNotificationSettings()">ä¿å­˜è®¾ç½®</button>
                <button type="button" class="btn btn-info" onclick="testNotification()">æµ‹è¯•é€šçŸ¥</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Checkin Settings Modal -->
    <div class="modal" id="checkinSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â° ç­¾åˆ°è®¾ç½®</h3>
                <button class="close" onclick="closeModal('checkinSettingsModal')">&times;</button>
            </div>
            <div class="modal-body-scroll">
                <div class="form-group">
                    <label>ç­¾åˆ°æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰</label>
                    <input type="time" id="globalCheckinTime" value="05:30" required>
                    <div class="format-hint">åˆ°è¾¾æ­¤æ—¶é—´åå¼€å§‹æ‰§è¡Œç­¾åˆ°</div>
                </div>
                <div class="form-group">
                    <label>é‡è¯•æ¬¡æ•°</label>
                    <input type="number" id="globalRetryCount" value="2" min="0" max="5" required>
                    <div class="format-hint">ç­¾åˆ°å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°ï¼ˆ0è¡¨ç¤ºä¸é‡è¯•ï¼‰</div>
                </div>
                <div class="form-group">
                    <label>éšæœºå»¶è¿ŸèŒƒå›´ï¼ˆç§’ï¼‰</label>
                    <div class="time-range-input">
                        <input type="number" id="globalRandomDelayMin" value="0" min="0" max="300" required>
                        <span>è‡³</span>
                        <input type="number" id="globalRandomDelayMax" value="30" min="0" max="300" required>
                    </div>
                    <div class="format-hint">æ¯ä¸ªè´¦å·ç­¾åˆ°å‰çš„éšæœºå»¶è¿Ÿæ—¶é—´ï¼Œé¿å…åŒæ—¶å‘èµ·è¯·æ±‚</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-full" onclick="saveCheckinSettings()">ä¿å­˜è®¾ç½®</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('checkinSettingsModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>