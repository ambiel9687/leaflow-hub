<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leaflow Auto Check-in Control Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🍃</text></svg>">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* 防止页面闪烁：初始隐藏所有容器 */
        .login-container, .dashboard { visibility: hidden; }
    </style>
    <script>
        // 立即根据 token 预设容器可见性，防止闪烁
        (function() {
            var hasToken = !!localStorage.getItem('authToken');
            var style = document.createElement('style');
            style.id = 'anti-flicker-style';
            style.textContent = hasToken
                ? '.login-container{display:none!important}.dashboard{display:block!important;visibility:visible!important}'
                : '.login-container{display:flex!important;visibility:visible!important}.dashboard{display:none!important}';
            document.head.appendChild(style);
        })();
    </script>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2>🔐 管理员登录</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="button" class="btn btn-full" id="loginBtn" onclick="handleLogin()">登录</button>
                <div class="error-message" id="loginError"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>🍃 Leaflow 自动签到控制面板</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-sm" onclick="showCheckinSettingsModal()" title="签到设置">
                            <span>⏰</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showNotificationModal()" title="通知设置">
                            <span>🔔</span>
                        </button>
                        <button class="btn btn-secondary btn-sm theme-toggle" onclick="toggleTheme()" title="切换主题">
                            <span class="theme-icon">🌙</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="logout()">退出</button>
                    </div>
                </div>
            </div>

            <!-- 第一排：账号与签到统计 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>账号总数</h3>
                    <div class="value value-default" id="totalAccounts">0</div>
                </div>
                <div class="stat-card">
                    <h3>活跃账号</h3>
                    <div class="value value-info" id="activeAccounts">0</div>
                </div>
                <div class="stat-card">
                    <h3>签到总数</h3>
                    <div class="value value-default" id="totalCheckins">0</div>
                </div>
                <div class="stat-card">
                    <h3>成功率</h3>
                    <div class="value value-success" id="successRate">0%</div>
                </div>
            </div>

            <!-- 第二排：余额与消费统计 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>总余额</h3>
                    <div class="value value-success" id="totalBalance">¥0.00</div>
                </div>
                <div class="stat-card">
                    <h3>总消费</h3>
                    <div class="value value-warning" id="totalConsumed">¥0.00</div>
                </div>
                <div class="stat-card">
                    <h3>使用率</h3>
                    <div class="value value-info" id="usageRate">0%</div>
                </div>
                <div class="stat-card">
                    <h3>今日签到</h3>
                    <div class="value value-success" id="todayCheckinAmount">¥0.00</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>👥 账号管理</h2>
                    <div class="button-group">
                        <button class="btn btn-success btn-sm" onclick="showAddAccountModal()">+ 添加账号</button>
                        <button class="btn btn-info btn-sm" onclick="refreshAllBalances()">刷新全部余额</button>
                        <button class="btn btn-warning btn-sm" onclick="clearCheckinHistory('today')">清空今日记录</button>
                        <button class="btn btn-danger btn-sm" onclick="clearCheckinHistory('all')">清空所有记录</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>基础信息</th>
                                <th>余额信息</th>
                                <th>状态</th>
                                <th>今日签到</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="accountsList">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #a0aec0;">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新账号</h3>
                <button class="close" onclick="closeModal('addAccountModal')">&times;</button>
            </div>
            <div id="addAccountForm">
                <div class="form-group">
                    <label>账号名称</label>
                    <input type="text" id="accountName" required>
                </div>
                <div class="form-group">
                    <label>Cookie 数据</label>
                    <textarea id="tokenData" rows="6" placeholder='支持格式：
1. JSON格式: {"cookies": {"key": "value"}}
2. 分号分隔: key1=value1; key2=value2
3. 完整cookie: leaflow_session=xxx; remember_xxx=xxx; XSRF-TOKEN=xxx' required></textarea>
                    <div class="format-hint">从浏览器开发者工具(F12) → Network → 请求头 → Cookie 复制</div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-full" onclick="addAccount()">添加账号</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addAccountModal')">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Account Modal -->
    <div class="modal" id="editAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editAccountTitle">修改账号</h3>
                <button class="close" onclick="closeModal('editAccountModal')">&times;</button>
            </div>
            <div id="editAccountForm">
                <input type="hidden" id="editAccountId">
                <div class="form-group">
                    <label>Cookie 数据（留空则不修改）</label>
                    <textarea id="editTokenData" rows="4" placeholder='支持格式：
1. JSON格式: {"cookies": {"key": "value"}}
2. 分号分隔: key1=value1; key2=value2
3. 完整cookie: leaflow_session=xxx; remember_xxx=xxx; XSRF-TOKEN=xxx'></textarea>
                    <div class="format-hint">从浏览器开发者工具(F12) → Network → 请求头 → Cookie 复制</div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-full" onclick="updateAccount()">保存修改</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editAccountModal')">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkin History Modal -->
    <div class="modal" id="checkinHistoryModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="historyModalTitle">签到历史</h3>
                <button class="close" onclick="closeModal('checkinHistoryModal')">&times;</button>
            </div>
            <input type="hidden" id="historyAccountId">
            <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllHistory" onchange="toggleSelectAllHistory()"></th>
                            <th>状态</th>
                            <th>消息</th>
                            <th>时间</th>
                        </tr>
                    </thead>
                    <tbody id="historyList">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #a0aec0;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-danger" onclick="deleteSelectedHistory()">删除选中</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('checkinHistoryModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal" id="notificationModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>🔔 通知设置</h3>
                <button class="close" onclick="closeModal('notificationModal')">&times;</button>
            </div>
            <div class="modal-body-scroll">
                <div class="form-group">
                    <div class="form-group-inline">
                        <input type="checkbox" id="notifyEnabled">
                        <label for="notifyEnabled" style="margin-bottom: 0;">启用通知功能</label>
                    </div>
                </div>

                <!-- Telegram通知设置 -->
                <div class="notification-channel">
                    <h4>📱 Telegram 通知设置</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="telegramEnabled">
                        <label for="telegramEnabled">启用 Telegram 通知</label>
                    </div>
                    <div class="form-group">
                        <label>Bot Token</label>
                        <input type="text" id="tgBotToken" placeholder="从 @BotFather 获取的 Bot Token">
                    </div>
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="tgUserId" placeholder="接收通知的用户ID">
                    </div>
                    <div class="form-group">
                        <label>API地址（可选）</label>
                        <input type="text" id="telegramHost" placeholder="https://api.telegram.org">
                        <div class="format-hint">留空使用默认地址</div>
                    </div>
                </div>

                <!-- 企业微信通知设置 -->
                <div class="notification-channel">
                    <h4>💼 企业微信通知设置</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="wechatEnabled">
                        <label for="wechatEnabled">启用企业微信通知</label>
                    </div>
                    <div class="form-group">
                        <label>Webhook Key</label>
                        <input type="text" id="wechatKey" placeholder="企业微信机器人的 Webhook Key">
                    </div>
                    <div class="form-group">
                        <label>API地址（可选）</label>
                        <input type="text" id="wechatHost" placeholder="https://qyapi.weixin.qq.com">
                        <div class="format-hint">留空使用默认地址</div>
                    </div>
                </div>

                <!-- WxPusher通知设置 -->
                <div class="notification-channel">
                    <h4>📨 WxPusher 消息通知设置</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="wxpusherEnabled">
                        <label for="wxpusherEnabled">启用 WxPusher 通知</label>
                    </div>
                    <div class="form-group">
                        <label>APP Token</label>
                        <input type="text" id="wxpusherAppToken" placeholder="AT_xxx">
                        <div class="format-hint">
                            <a href="https://wxpusher.zjiecode.com/docs/#/" target="_blank" class="help-link">
                                访问 WxPusher 文档获取 Token 和 UID
                            </a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>UID</label>
                        <input type="text" id="wxpusherUid" placeholder="UID_xxx">
                    </div>
                    <div class="form-group">
                        <label>API地址（可选）</label>
                        <input type="text" id="wxpusherHost" placeholder="https://wxpusher.zjiecode.com">
                        <div class="format-hint">留空使用默认地址</div>
                    </div>
                </div>

                <!-- 钉钉机器人通知设置 -->
                <div class="notification-channel">
                    <h4>🤖 钉钉机器人通知设置</h4>
                    <div class="channel-toggle">
                        <input type="checkbox" id="dingtalkEnabled">
                        <label for="dingtalkEnabled">启用钉钉机器人通知</label>
                    </div>
                    <div class="form-group">
                        <label>Access Token</label>
                        <input type="text" id="dingtalkAccessToken" placeholder="机器人的 Access Token">
                        <div class="format-hint">
                            <a href="https://open.dingtalk.com/document/orgapp/obtain-the-webhook-address-of-a-custom-robot" target="_blank" class="help-link">
                                获取钉钉机器人配置
                            </a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>加签密钥</label>
                        <input type="text" id="dingtalkSecret" placeholder="安全设置中的加签密钥">
                    </div>
                    <div class="form-group">
                        <label>API地址（可选）</label>
                        <input type="text" id="dingtalkHost" placeholder="https://oapi.dingtalk.com">
                        <div class="format-hint">留空使用默认地址</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-full" onclick="saveNotificationSettings()">保存设置</button>
                <button type="button" class="btn btn-info" onclick="testNotification()">测试通知</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Checkin Settings Modal -->
    <div class="modal" id="checkinSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⏰ 签到设置</h3>
                <button class="close" onclick="closeModal('checkinSettingsModal')">&times;</button>
            </div>
            <div class="modal-body-scroll">
                <div class="form-group">
                    <label>签到时间（北京时间）</label>
                    <input type="time" id="globalCheckinTime" value="05:30" required>
                    <div class="format-hint">到达此时间后开始执行签到</div>
                </div>
                <div class="form-group">
                    <label>重试次数</label>
                    <input type="number" id="globalRetryCount" value="2" min="0" max="5" required>
                    <div class="format-hint">签到失败时的重试次数（0表示不重试）</div>
                </div>
                <div class="form-group">
                    <label>随机延迟范围（秒）</label>
                    <div class="time-range-input">
                        <input type="number" id="globalRandomDelayMin" value="0" min="0" max="300" required>
                        <span>至</span>
                        <input type="number" id="globalRandomDelayMax" value="30" min="0" max="300" required>
                    </div>
                    <div class="format-hint">每个账号签到前的随机延迟时间，避免同时发起请求</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-full" onclick="saveCheckinSettings()">保存设置</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('checkinSettingsModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Redeem Code Modal -->
    <div class="modal" id="redeemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="redeemModalTitle">🎁 兑换码</h3>
                <button class="close" onclick="closeModal('redeemModal')">&times;</button>
            </div>
            <input type="hidden" id="redeemAccountId">

            <!-- Tab 切换 -->
            <div class="redeem-tabs">
                <button class="tab-btn active" data-tab="single" onclick="switchRedeemTab('single')">单次兑换</button>
                <button class="tab-btn" data-tab="batch" onclick="switchRedeemTab('batch')">批量兑换</button>
            </div>

            <!-- 单次兑换 Tab -->
            <div class="tab-content active" id="singleRedeemTab">
                <div id="redeemCountdownSection" style="margin-bottom: 12px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; text-align: left; display: none;"></div>
                <div class="form-group">
                    <label>兑换码</label>
                    <input type="text" id="redeemCode" placeholder="请输入兑换码" required>
                    <div class="format-hint">每小时只能兑换一次</div>
                </div>
                <div id="redeemHistorySection" style="margin-top: 15px; display: none;">
                    <label style="font-size: 12px; color: var(--text-secondary);">最近兑换记录</label>
                    <div id="redeemHistoryList" style="max-height: 150px; overflow-y: auto; margin-top: 8px;"></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-full" onclick="submitRedeem()">兑换</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('redeemModal')">取消</button>
                </div>
            </div>

            <!-- 批量兑换 Tab -->
            <div class="tab-content" id="batchRedeemTab">
                <div class="form-group">
                    <label>兑换码（多个）</label>
                    <textarea id="batchRedeemCodes" rows="5" placeholder="每行一个兑换码，或用逗号分隔" oninput="updateBatchCodeCount()"></textarea>
                    <div class="format-hint">共 <span id="batchCodeCount">0</span> 个兑换码 · 成功间隔70分钟 · 失败间隔1分钟</div>
                </div>

                <!-- 批量任务进度区域 -->
                <div id="batchProgressSection" class="batch-progress-section" style="display: none;">
                    <div class="batch-progress-header">
                        <span class="batch-status-badge" id="batchStatusBadge">运行中</span>
                        <span>进度: <strong id="batchCurrentIndex">0</strong>/<span id="batchTotalCount">0</span></span>
                        <span style="color: var(--badge-success-color);">成功: <span id="batchSuccessCount">0</span></span>
                        <span style="color: var(--badge-danger-color);">失败: <span id="batchFailCount">0</span></span>
                    </div>
                    <div id="batchNextExecute" class="batch-next-execute" style="display: none;"></div>
                    <div id="batchCodeList" class="batch-code-list"></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-full" id="startBatchBtn" onclick="startBatchRedeem()">开始批量兑换</button>
                    <button type="button" class="btn btn-warning" id="pauseBatchBtn" style="display: none;" onclick="pauseBatchRedeem()">暂停</button>
                    <button type="button" class="btn btn-full" id="resumeBatchBtn" style="display: none;" onclick="resumeBatchRedeem()">继续</button>
                    <button type="button" class="btn btn-danger" id="cancelBatchBtn" style="display: none;" onclick="cancelBatchRedeem()">取消</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('redeemModal')">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>